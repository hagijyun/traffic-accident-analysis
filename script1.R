


# 1. 自転車事故データの抽出と集計
bicycle_accidents <- subset(x, 
  grepl("自転車", 当事者種別.当事者A.) | grepl("自転車", 当事者種別.当事者B.)
)

# 都道府県ごとの自転車事故件数を集計
prefecture_table <- table(bicycle_accidents$都道府県名)
bicycle_summary <- data.frame(
  都道府県名 = names(prefecture_table),
  自転車事故件数 = as.numeric(prefecture_table)
)
bicycle_summary <- bicycle_summary[order(bicycle_summary$自転車事故件数, decreasing = TRUE), ]

# 2. 北海道地域を除外
bicycle_no_hokkaido <- bicycle_summary[!grepl("北海道", bicycle_summary$都道府県名), ]

# 3. 人口データの準備（2024年住民基本台帳）
population_2024 <- data.frame(
  都道府県名 = c("青森", "岩手", "宮城", "秋田", "山形", "福島",
                "茨城", "栃木", "群馬", "埼玉", "千葉", "東京", "神奈川",
                "新潟", "富山", "石川", "福井", "山梨", "長野", 
                "岐阜", "静岡", "愛知", "三重",
                "滋賀", "京都", "大阪", "兵庫", "奈良", "和歌山",
                "鳥取", "島根", "岡山", "広島", "山口",
                "徳島", "香川", "愛媛", "高知",
                "福岡", "佐賀", "長崎", "熊本", "大分", "宮崎", "鹿児島", "沖縄"),
  人口 = c(1217474, 1194656, 2281585, 928635, 1047552, 1811691,
          2843370, 1916683, 1921259, 7317552, 6253616, 13794933, 9198717,
          2180018, 1027595, 1128750, 761178, 805974, 2033240,
          1964679, 3604034, 7513207, 1760654,
          1406840, 2565391, 8776450, 5430039, 1316025, 914902,
          547118, 666626, 1873894, 2783748, 1329729,
          722584, 945493, 1320324, 686894,
          5078003, 807691, 1302832, 1722574, 1115303, 1064778, 1576779, 1453802)
)

# 4. データの結合
merged_data <- merge(bicycle_no_hokkaido, population_2024, by = "都道府県名", all.x = TRUE)

# 結合チェック
cat("結合できなかった都道府県の数:", sum(is.na(merged_data$人口)), "\n")
if(sum(is.na(merged_data$人口)) > 0) {
  cat("結合できなかった都道府県:\n")
  print(merged_data[is.na(merged_data$人口), "都道府県名"])
}

# 5. 人口当たり事故率の計算
merged_data$人口1万人当たり事故件数 <- round((merged_data$自転車事故件数 / merged_data$人口) * 10000, 2)
merged_data$人口10万人当たり事故件数 <- round((merged_data$自転車事故件数 / merged_data$人口) * 100000, 2)

# 6. 人口1万人当たり事故件数で並べ替え（降順）
merged_data <- merged_data[order(merged_data$人口1万人当たり事故件数, decreasing = TRUE), ]

# 7. 結果表示
cat("\n=== 分析結果 ===\n")
print(head(merged_data, 10))

cat("\n人口1万人当たり自転車事故件数 上位5都道府県:\n")
print(head(merged_data[, c("都道府県名", "自転車事故件数", "人口", "人口1万人当たり事故件数")], 5))

cat("\n人口1万人当たり自転車事故件数 下位5都道府県:\n")
print(tail(merged_data[, c("都道府県名", "自転車事故件数", "人口", "人口1万人当たり事故件数")], 5))

# 8. 基本統計
cat("\n=== 基本統計 ===\n")
summary(merged_data$人口1万人当たり事故件数)

# 9. 全国平均
national_avg <- mean(merged_data$人口1万人当たり事故件数, na.rm = TRUE)
cat("\n全国平均（人口1万人当たり）:", round(national_avg, 2), "件\n")

above_avg <- merged_data[merged_data$人口1万人当たり事故件数 > national_avg, ]
cat("全国平均を上回る都道府県数:", nrow(above_avg), "/", nrow(merged_data), "\n")

# 10. 可視化
# 上位15都道府県の棒グラフ
top15 <- head(merged_data, 15)
par(mar = c(8, 4, 4, 2))
barplot(top15$人口1万人当たり事故件数,
        names.arg = top15$都道府県名,
        main = "都道府県別 人口1万人当たり自転車事故件数 上位15",
        ylab = "人口1万人当たり事故件数",
        las = 2,
        col = "steelblue",
        cex.names = 0.8)

# 上位6県にラベル付け
top6 <- head(merged_data, 6)

# 11. 散布図：絶対数 vs 人口当たり
par(mar = c(5, 4, 4, 2))
plot(merged_data$自転車事故件数, merged_data$人口1万人当たり事故件数,
     xlab = "絶対事故件数", 
     ylab = "人口1万人当たり事故件数",
     main = "自転車事故：絶対数 vs 人口当たり事故率",
     pch = 19, col = "blue")

text(top6$自転車事故件数, top6$人口1万人当たり事故件数,
     labels = top6$都道府県名, pos = 3, cex = 0.8, col = "red")


par(mar = c(5, 4, 4, 2))
plot(merged_data$自転車事故件数, merged_data$人口1万人当たり事故件数,
     xlab = "絶対事故件数", 
     ylab = "人口1万人当たり事故件数",
     main = "自転車事故：絶対数（対数） vs 人口当たり事故率",
     pch = 19, col = "blue", log = "x")

text(top6$自転車事故件数, top6$人口1万人当たり事故件数,
     labels = top6$都道府県名, pos = 3, cex = 0.8, col = "red")


# 12. 回帰分析

# 回帰分析（対数変換したx値で）
model <- lm(人口1万人当たり事故件数 ~ log10(自転車事故件数), 
            data = merged_data)

# 回帰直線を追加
x_seq <- 10^seq(log10(min(merged_data$自転車事故件数)), 
                log10(max(merged_data$自転車事故件数)), 
                length.out = 100)
y_pred <- predict(model, newdata = data.frame(自転車事故件数 = x_seq))
lines(x_seq, y_pred, col = "red", lwd = 2)

# 決定係数を表示
legend("topright", 
       legend = paste("R² =", round(summary(model)$r.squared, 3)),
       bty = "n")

# 回帰分析の詳細表示
summary(model)

# 相関係数
cor(log10(merged_data$自転車事故件数), 
    merged_data$人口1万人当たり事故件数)


















兵庫県の市区町村コードを以下に示します。

### 兵庫県（28）の市区町村コード一覧
兵庫県の市区町村コードは、総務省の定める標準地域コードに基づき、以下のようになっています。

* **28100**：神戸市
    * 28101：神戸市東灘区
    * 28102：神戸市灘区
    * 28103：神戸市兵庫区
    * 28104：神戸市長田区
    * 28105：神戸市須磨区
    * 28106：神戸市垂水区
    * 28107：神戸市北区
    * 28108：神戸市中央区
    * 28109：神戸市西区
* **28200**：姫路市
* **28202**：尼崎市
* **28203**：明石市
* **28204**：西宮市
* **28205**：洲本市
* **28206**：芦屋市
* **28207**：伊丹市
* **28208**：相生市
* **28209**：豊岡市
* **28210**：加古川市
* **28212**：赤穂市
* **28213**：西脇市
* **28214**：宝塚市
* **28215**：三木市
* **28216**：高砂市
* **28217**：川西市
* **28219**：小野市
* **28220**：三田市
* **28221**：加西市
* **28223**：丹波篠山市
* **28224**：養父市
* **28225**：丹波市
* **28226**：南あわじ市
* **28227**：朝来市
* **28228**：淡路市
* **28229**：宍粟市
* **28230**：加東市
* **28231**：たつの市
* **28301**：猪名川町
* **28381**：多可町
* **28442**：稲美町
* **28443**：播磨町
* **28464**：市川町
* **28465**：福崎町
* **28482**：神河町
* **28585**：太子町
* **28586**：上郡町
* **28664**：佐用町
* **28674**：香美町
* **28675**：新温泉町

---

### コードについての補足情報
総務省の定める**標準地域コード**は、地方公共団体（都道府県・市区町村）を一意に識別するために用いられる5桁のコードです。都道府県コード（2桁）と市区町村コード（3桁）から構成されます。

* **兵庫県**の都道府県コードは**28**です。
* 市区町村コードは、冒頭の`head()`で示されたデータフレームの`市区町村コード`列から`101`（神戸市東灘区）のように読み取れます。これは、**兵庫県**のコード`28`と組み合わせることで**28101**となり、総務省の標準地域コードに一致します。



当事者A（第一当事者）：事故において最も過失が重い人、または人身傷害が最も軽い人 
当事者B（第二当事者）：当事者Aに次いで過失が重い人 
